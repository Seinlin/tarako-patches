From f461129e16ce7205a7e19f1031df1f3108dba49f Mon Sep 17 00:00:00 2001
From: Kai-Zhen Li <kli@mozilla.com>
Date: Mon, 20 Jan 2014 16:43:16 +0800
Subject: [PATCH 13/13] Bug 960516 - WIP to fix app launch issue.

---
 dom/base/nsJSEnvironment.cpp |    9 +++++++++
 dom/ipc/ContentParent.cpp    |    5 +++++
 2 files changed, 14 insertions(+)

diff --git a/dom/base/nsJSEnvironment.cpp b/dom/base/nsJSEnvironment.cpp
index 649b990..11b10ff 100644
--- a/dom/base/nsJSEnvironment.cpp
+++ b/dom/base/nsJSEnvironment.cpp
@@ -87,6 +87,10 @@
 #include "nsCycleCollectionNoteRootCallback.h"
 #include "GeckoProfiler.h"
 
+#ifdef MOZ_NUWA_PROCESS
+#include "ipc/Nuwa.h"
+#endif
+
 using namespace mozilla;
 using namespace mozilla::dom;
 
@@ -2434,6 +2438,11 @@ nsJSContext::MaybePokeCC()
     return;
   }
 
+#ifdef MOZ_NUWA_PROCESS
+  if (IsNuwaProcess() && IsNuwaReady()) {
+    return;
+  }
+#endif
   if (ShouldTriggerCC(nsCycleCollector_suspectedCount())) {
     sCCTimerFireCount = 0;
     CallCreateInstance("@mozilla.org/timer;1", &sCCTimer);
diff --git a/dom/ipc/ContentParent.cpp b/dom/ipc/ContentParent.cpp
index 8815ab2..3a338c0 100644
--- a/dom/ipc/ContentParent.cpp
+++ b/dom/ipc/ContentParent.cpp
@@ -1854,6 +1854,11 @@ ContentParent::Observe(nsISupports* aSubject,
     if (!mIsAlive || !mSubprocess)
         return NS_OK;
 
+#ifdef MOZ_NUWA_PROCESS
+    if (mIsNuwaProcess) {
+        return NS_OK;
+    }
+#endif
     // listening for memory pressure event
     if (!strcmp(aTopic, "memory-pressure") &&
         !StringEndsWith(nsDependentString(aData),
-- 
1.7.9.5

